sequenceDiagram
    autonumber
    participant C as å‰ç«¯ (Vue3)
    participant F as FastAPI
    participant R as Redis
    participant S as Supabase Auth
    participant DB as Supabase DB

    Note over C,DB: ğŸ” ç™»å…¥æµç¨‹

    C->>F: POST /api/v1/auth/login<br/>{email, password}
    F->>S: sign_in_with_password()
    S-->>F: {user, session, tokens}
    F->>DB: æŸ¥è©¢ user_profiles å–å¾—è§’è‰²
    DB-->>F: {role: "student"}
    
    F->>F: ç”¢ç”Ÿè‡ªè¨‚ JWT Token<br/>(Access + Refresh)
    F->>R: å»ºç«‹ Session<br/>SET session:{hash} {data}
    F->>R: è¨˜éŒ„ç”¨æˆ¶ Sessions<br/>SADD user_sessions:{id} {hash}
    R-->>F: OK
    
    F-->>C: Set-Cookie: access_token (HttpOnly)<br/>Set-Cookie: refresh_token (HttpOnly)<br/>Set-Cookie: session_id (HttpOnly)<br/>{user, tokens}

    Note over C,DB: ğŸ”‘ èªè­‰è«‹æ±‚æµç¨‹

    C->>F: GET /api/v1/users/profile<br/>Cookie: access_token, session_id
    F->>R: æª¢æŸ¥ Token é»‘åå–®<br/>EXISTS blacklist:{hash}
    R-->>F: 0 (ä¸åœ¨é»‘åå–®)
    F->>F: è§£ç¢¼ JWT Token
    F->>R: é©—è­‰ Session<br/>GET session:{hash}
    R-->>F: {user_id, role, ...}
    F->>R: æ›´æ–°æ´»å‹•æ™‚é–“<br/>SET session:{hash} {updated}
    F->>DB: æŸ¥è©¢ç”¨æˆ¶è³‡æ–™
    DB-->>F: {profile data}
    F-->>C: {user profile}

    Note over C,DB: ğŸ”„ Token åˆ·æ–°æµç¨‹

    C->>F: POST /api/v1/auth/refresh<br/>Cookie: refresh_token, session_id
    F->>R: æª¢æŸ¥ Refresh Token é»‘åå–®
    R-->>F: 0 (ä¸åœ¨é»‘åå–®)
    F->>F: é©—è­‰ Refresh Token
    F->>R: é©—è­‰ Session å­˜åœ¨
    R-->>F: Session æœ‰æ•ˆ
    
    F->>F: ç”¢ç”Ÿæ–°çš„ Token Pair
    F->>R: èˆŠ Refresh Token åŠ å…¥é»‘åå–®<br/>SET blacklist:{hash} 1 EX 604800
    R-->>F: OK
    
    F-->>C: Set-Cookie: æ–° access_token<br/>Set-Cookie: æ–° refresh_token

    Note over C,DB: ğŸšª ç™»å‡ºæµç¨‹

    C->>F: POST /api/v1/auth/logout<br/>Cookie: access_token, session_id
    F->>R: å–å¾— Session è³‡æ–™
    R-->>F: {user_id, ...}
    F->>R: åˆªé™¤ Session<br/>DEL session:{hash}
    F->>R: å¾ç”¨æˆ¶ Sessions ç§»é™¤<br/>SREM user_sessions:{id} {hash}
    F->>R: Access Token åŠ å…¥é»‘åå–®<br/>SET blacklist:{hash} 1 EX 900
    R-->>F: OK
    
    F->>S: sign_out()
    S-->>F: OK
    
    F-->>C: Set-Cookie: æ¸…é™¤æ‰€æœ‰ Cookies<br/>{success: true}

    Note over C,DB: ğŸ”’ ç™»å‡ºæ‰€æœ‰è£ç½®

    C->>F: POST /api/v1/auth/logout<br/>{logout_all_devices: true}
    F->>R: å–å¾—æ‰€æœ‰ Sessions<br/>SMEMBERS user_sessions:{id}
    R-->>F: [session1, session2, ...]
    
    loop æ¯å€‹ Session
        F->>R: DEL session:{hash}
    end
    
    F->>R: åˆªé™¤ç”¨æˆ¶ Sessions é›†åˆ<br/>DEL user_sessions:{id}
    F->>R: æ¸…é™¤ç”¨æˆ¶å¿«å–<br/>DEL user_profile:{id}
    R-->>F: OK
    
    F-->>C: {success: true, message: "å·²ç™»å‡ºæ‰€æœ‰è£ç½®"}
